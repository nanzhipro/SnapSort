# SnapSort macOS 应用架构目录结构

## 目录结构

```
SnapSort/
├── App/
│   ├── SnapSortApp.swift                  # 应用入口
│   ├── AppDelegate.swift                  # 应用委托
│   └── DependencyInjection/               # 依赖注入容器
│       └── DIContainer.swift
│
├── Presentation/                          # 表现层
│   ├── Views/                             # 视图层
│   │   ├── Main/                          # 主视图
│   │   │   ├── MainView.swift             # 主视图（菜单栏图标）
│   │   │   └── StatusBarController.swift  # 状态栏控制器
│   │   ├── Settings/                      # 设置视图
│   │   │   ├── SettingsView.swift         # 设置主视图
│   │   │   ├── GeneralSettingsView.swift  # 通用设置视图
│   │   │   ├── CategoriesSettingsView.swift # 分类设置视图
│   │   │   ├── DirectoriesSettingsView.swift # 目录设置视图
│   │   │   └── AISettingsView.swift       # AI分类设置视图
│   │   ├── Components/                    # 可复用组件
│   │   │   ├── CategoryList/              # 分类列表组件
│   │   │   ├── DirectoryPicker/           # 目录选择器组件
│   │   │   ├── KeywordEditor/             # 关键词编辑器组件
│   │   │   └── NotificationBanner/        # 通知横幅组件
│   │   └── DesignSystem/                  # 设计系统
│   │       ├── Colors.swift               # 颜色定义
│   │       ├── Typography.swift           # 排版定义
│   │       └── ViewModifiers.swift        # 视图修饰符
│   │
│   └── ViewModels/                        # 视图模型层
│       ├── MainViewModel.swift            # 主视图模型
│       ├── SettingsViewModel.swift        # 设置视图模型
│       ├── CategoriesViewModel.swift      # 分类视图模型
│       └── ScreenshotClassifierViewModel.swift # 截图分类视图模型
│
├── Domain/                                # 领域层
│   ├── Models/                            # 数据模型
│   │   ├── Screenshot.swift               # 截图模型
│   │   ├── Category.swift                 # 分类模型
│   │   ├── ClassificationResult.swift     # 分类结果模型
│   │   └── Settings.swift                 # 设置模型
│   │
│   └── Protocols/                         # 领域协议(更符合Swift命名)
│       ├── ScreenshotRepositoryProtocol.swift # 截图存储库协议
│       ├── CategoryRepositoryProtocol.swift   # 分类存储库协议
│       ├── SettingsRepositoryProtocol.swift   # 设置存储库协议
│       ├── ClassifierProtocol.swift           # 分类器协议
│       └── OCRProcessorProtocol.swift         # OCR处理器协议
│
├── Data/                                  # 数据层
│   ├── Repositories/                      # 存储库实现
│   │   ├── ScreenshotRepository.swift     # 截图存储库实现
│   │   ├── CategoryRepository.swift       # 分类存储库实现
│   │   └── SettingsRepository.swift       # 设置存储库实现
│   ├── SQLiteManager.swift                # SQLite管理器
│   ├── UserDefaultsManager.swift          # UserDefaults管理器
│   ├── DeepSeekAPI.swift                  # DeepSeek API
│   ├── ClassificationRequest.swift        # 分类请求模型
│   ├── ClassificationResponse.swift       # 分类响应模型
│   ├── NetworkManager.swift               # 网络管理器
│   └── HTTPClient.swift                   # HTTP客户端
│
├── Infrastructure/                        # 基础设施层
│   ├── Extensions/                        # 扩展
│   │   ├── NSImage+Extensions.swift
│   │   ├── String+Extensions.swift
│   │   └── URL+Extensions.swift
│   │
│   ├── Services/                          # 服务
│   │   ├── MetadataMonitor/               # 元数据监控
│   │   │   └── NSMetadataQueryManager.swift
│   │   ├── OCR/                           # OCR服务
│   │   │   └── VisionOCRService.swift
│   │   ├── FileSystem/                    # 文件系统服务
│   │   │   └── FileSystemService.swift
│   │   ├── AI/                            # AI服务
│   │   │   ├── LocalAIService.swift       # 本地AI服务
│   │   │   └── DeepSeekService.swift      # DeepSeek AI服务
│   │   └── Notifications/                 # 通知服务
│   │       └── NotificationService.swift
│   │
│   ├── Utils/                             # 工具类
│   │   ├── Logger.swift                   # 日志工具
│   │   ├── KeychainManager.swift          # 钥匙串管理器
│   │   ├── LaunchAtLoginManager.swift     # 开机启动管理器
│   │   └── Constants.swift                # 常量定义
│   │
│   ├── Concurrency/                       # 并发处理
│   │   ├── AsyncTaskQueue.swift           # 异步任务队列
│   │   └── AsyncOperation.swift           # 异步操作
│   │
│   └── Security/                          # 安全
│       └── SensitiveInfoDetector.swift    # 敏感信息检测器
│
├── Resources/                             # 资源
│   ├── Assets.xcassets                    # 资源目录
│   ├── Info.plist                         # 信息属性列表
│   └── Localization/                      # 国际化
│       ├── en.lproj/                      # 英文
│       │   └── Localizable.strings
│       ├── zh-Hans.lproj/                 # 简体中文
│       │   └── Localizable.strings
│       └── ja.lproj/                      # 日文
│           └── Localizable.strings
│
├── Configurations/                        # 配置文件
│   ├── Debug.xcconfig                     # 调试配置
│   ├── Release.xcconfig                   # 发布配置
│   └── Common.xcconfig                    # 通用配置
│
└── Tests/                                 # 测试
    ├── UnitTests/                         # 单元测试
    │   ├── Domain/                        # 领域层测试
    │   │   └── Models/                    # 模型测试
    │   ├── Data/                          # 数据层测试
    │   │   ├── Repositories/              # 仓库测试
    │   │   └── Network/                   # 网络测试
    │   └── Presentation/                  # 表现层测试
    │       └── ViewModels/                # 视图模型测试
    │
    └── IntegrationTests/                  # 集成测试
        ├── Screenshot/                    # 截图流程测试
        ├── OCR/                           # OCR集成测试
        └── Classification/                # 分类集成测试
```

## 架构设计说明

### 1. 整体架构

SnapSort应用采用MVVM和Clean Architecture相结合的架构设计，以确保代码的可维护性、可测试性和可扩展性。这种架构将应用分为几个独立的层次：

- **表现层(Presentation)**: 包含Views和ViewModels，负责UI展示和用户交互
- **领域层(Domain)**: 包含业务模型和业务逻辑
- **数据层(Data)**: 负责数据获取和存储，包括本地和远程数据源
- **基础设施层(Infrastructure)**: 提供跨层次的共享功能和服务

### 2. 关键组件说明

#### 应用核心(App)

- **SnapSortApp.swift**: 应用的入口点，使用SwiftUI的App协议
- **AppDelegate.swift**: 传统的AppDelegate，处理应用生命周期事件
- **DIContainer**: 依赖注入容器，管理应用中各组件的创建和生命周期

#### 表现层(Presentation)

- **Views**: 使用SwiftUI构建的所有视图，分为Main、Settings等模块
- **Components**: 可复用的UI组件，便于在不同视图中共享
- **DesignSystem**: 设计系统组件，包括颜色、排版和修饰符
- **ViewModels**: 视图模型，处理视图的业务逻辑

#### 领域层(Domain)

- **Models**: 核心业务模型，表示应用的领域概念
- **Protocols**: 定义数据访问和功能接口，遵循依赖倒置原则，采用Protocol后缀，符合Swift命名习惯

#### 数据层(Data)

- **Repositories**: 实现领域层定义的仓库协议
- **SQLiteManager, UserDefaultsManager**: 本地数据管理
- **NetworkManager, DeepSeekAPI**: 网络和API交互

#### 基础设施层(Infrastructure)

- **Extensions**: Swift扩展，提供额外的功能
- **Services**: 提供截图监控、OCR、文件系统等底层服务
- **Utils**: 通用工具类，如日志、钥匙串访问等
- **Concurrency**: 异步并发处理工具
- **Security**: 安全相关功能

#### 资源(Resources)

- **Assets**: 应用图标、颜色等资源
- **Localization**: 国际化资源，支持中英日三语

#### 配置(Configurations)

- 不同环境的配置文件，包括开发、生产环境的特定设置

#### 测试(Tests)

- **UnitTests**: 针对各个层级的单元测试
- **IntegrationTests**: 跨层级的集成测试，测试完整功能流程

### 3. 组件化和复用设计

为支持组件化开发和代码复用：

1. **UI组件**: `/Presentation/Views/Components`目录包含各种可复用UI组件
2. **设计系统**: `/Presentation/Views/DesignSystem`提供统一的UI设计语言
3. **核心服务封装**: 如OCR、AI分类等核心功能被封装成独立服务，便于复用
4. **依赖注入设计**: 通过DI容器实现松耦合，便于将组件迁移到其他项目
5. **接口隔离**: 通过协议定义与实现分离，提高模块独立性
6. **通用工具封装**: 在Infrastructure层中封装通用功能，可作为独立模块使用

### 4. 数据流设计

应用中的数据流遵循单向数据流原则：

1. **用户交互** → **ViewModel** → **Repository** → **DataSource**(本地/远程)
2. **DataSource** → **Repository** → **ViewModel** → **View更新**

这种设计确保数据流的可预测性，便于调试和维护。

### 5. 通信机制

组件间通信采用多种机制：

1. **基于协议**: 主要用于跨层通信，如ViewModel调用Repository
2. **组合/依赖注入**: 通过构造函数注入依赖
3. **发布-订阅**: 截图监控→处理流程采用通知/观察者模式
4. **Combine框架**: 利用Swift的Combine框架实现响应式数据流

### 6. 可扩展性设计

架构设计考虑了未来可能的扩展：

1. **分类引擎扩展**: 可通过实现ClassifierProtocol添加新的分类引擎
2. **OCR引擎扩展**: 可通过实现OCRProcessorProtocol替换Vision框架为其他OCR引擎
3. **存储层扩展**: 可以添加新的数据存储实现
4. **新功能模块**: 可以在现有架构中轻松添加新的功能模块

### 7. 安全与隐私设计

考虑到应用处理用户截图的敏感性：

1. **API密钥存储**: 使用KeychainManager安全存储API密钥
2. **敏感信息检测**: SensitiveInfoDetector用于筛查敏感内容
3. **本地处理优先**: 架构支持本地AI处理，减少数据传输
4. **安全测试**: 专门的测试用例验证敏感信息处理流程

### 8. 测试策略

完整的测试覆盖确保应用质量：

1. **单元测试**: 针对各个层级的独立功能
2. **集成测试**: 验证跨层级的功能流程
3. **模拟数据**: 使用测试替身(Test doubles)隔离依赖
4. **UI测试**: 使用XCTest验证用户界面功能

```
